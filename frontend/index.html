<!doctype html>
<head>
  <title>Decima</title>

  <!-- Meta information -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

  <!-- Styles -->
  <link rel="stylesheet" href="main.css" />
  <link rel="stylesheet" href="bower_components/pure/pure-min.css" />
  <link rel="stylesheet" href="bower_components/pure/grids-responsive-min.css">
  <link rel="stylesheet" href="bower_components/pure/tables-min.css">
  <link rel="stylesheet" href="bower_components/pure/forms-min.css">

  <script src="bower_components/handlebars/handlebars.min.js"></script>
  <script src="bower_components/fetch/fetch.js"></script>
  <script src="bower_components/marked/lib/marked.js"></script>

  <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
</head>
<body>
  <div class="wrapper">
    <div class="content">
      <h1>Decima</h1>

      <div class="log">
        <h3 class="capitalized">9th / Thursday</h3>
        <ul class="fa-ul">
          <li><span class="fa-li"><i class="fa fa-angle-right"></i></span><span class="tag">#movie</span>: Three Billboards outside Ebbing Missouri <span><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i></span></li>
          <li style="opacity: 0.3"><span class="fa-li"><i class="fa fa-angle-right"></i></span>New Ninja Sex Party video: Orgy for One <span class="rating"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span></li>
          <li><span class="fa-li"><i class="fa fa-angle-right"></i></span>New <a href="#">Ninja Sex Party</a> video: Orgy for One <span class="rating"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span></li>
          <li><span class="fa-li"><i class="fas fa-check-circle"></i></span>Completed todo</li>
          <li><span class="fa-li"><i class="far fa-circle"></i></span>Unfinished todo</li>
        </ul>
      </div>

      <div class="log" id="log"></div>

      <hr/>

      <form id="date-form" class="pure-form">
        <fieldset>
          <input type="text" name="entry" placeholder="New entry...">
          <button type="submit" class="pure-button pure-button-primary">Submit</button>
        </fieldset>
      </form>
    </div>
  </div>

  <div style="width: 100%; padding-bottom: 2em"></div>

  <script id="table-template" type="text/x-handlebars-template">
    <h3 class="capitalized">9th / Thursday</h2>
    {{#each this}}
      <ul>
        <li>{{md content.Text.content}}</li>
      </ul>
    {{/each}}
  </script>

  <script id="error-template" type="text/x-handlebars-template">
    <div class="error">
      {{error}}
    </div>
  </script>

  <script>
  (function () {
    Handlebars.registerHelper('md', function(data) {
      return new Handlebars.SafeString(marked.inlineLexer(data, [], {}));
    });

    var loadTemplate = function (id) {
      return Handlebars.compile(document.getElementById(id).innerHTML);
    };

    var tableTemplate = loadTemplate('table-template');
    var errorTemplate = loadTemplate('error-template');

    var reportError = function (error) {
      var content = errorTemplate({ error: error });
      document.getElementById('log').innerHTML = content;
    };

    var processForm = function (event) {
      if (event.preventDefault) event.preventDefault();

      var dateField = event.target.querySelectorAll('[name=entry]')[0];

      fetch('api/log')
        .then(function (response) {
          var futureContent = null;

          if (response.status == 200 || response.status == 400) {
            futureContent = response.json();
          } else {
            futureContent = response.text();
          }

          return futureContent.then(function (content) {
            return { success: response.status == 200, content: content };
          });
        })
        .then(function (response) {
          if (response.success) {
            var content = tableTemplate(response.content);
            document.getElementById('log').innerHTML = content;
          } else {
            reportError(response.content);
          }
        })
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        });

      // prevent default form handler from running
      return false;
    }

    var form = document.getElementById('date-form');

    if (form.attachEvent) {
        form.attachEvent('submit', processForm);
    } else {
        form.addEventListener('submit', processForm);
    }
  })();
  </script>
</body>
