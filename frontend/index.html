<!doctype html>
<head>
  <title>Decima</title>

  <!-- Meta information -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

  <!-- Styles -->
  <link rel="stylesheet" href="main.css" />
  <link rel="stylesheet" href="bower_components/pure/pure-min.css" />
  <link rel="stylesheet" href="bower_components/pure/grids-responsive-min.css">
  <link rel="stylesheet" href="bower_components/pure/tables-min.css">
  <link rel="stylesheet" href="bower_components/pure/forms-min.css">

  <script src="bower_components/handlebars/handlebars.min.js"></script>
  <script src="bower_components/fetch/fetch.js"></script>
  <script src="bower_components/marked/lib/marked.js"></script>

  <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
</head>
<body>
  <div class="wrapper">
    <div class="content">
      <h1>Decima</h1>

      <div class="log">
        <h3 class="capitalized">9th / Thursday</h3>
        <ul class="fa-ul">
          <li><span class="fa-li badge" data-badge="3"><i class="fa fa-angle-right"></i></span><code>#movie</code>: Three Billboards outside Ebbing Missouri <span><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i></span></li>
          <li style="opacity: 0.3"><span class="fa-li badge" data-badge="9"><i class="fa fa-angle-right"></i></span>New Ninja Sex Party video: Orgy for One <span class="rating"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span></li>
          <li><span class="fa-li"><i class="fa fa-angle-right"></i></span>New <a href="#">Ninja Sex Party</a> video: Orgy for One <span class="rating"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span></li>
          <li><span class="fa-li"><i class="fas fa-check-circle"></i></span>Completed todo</li>
          <li><span class="fa-li"><i class="far fa-circle"></i></span>Unfinished todo</li>
        </ul>
      </div>

      <form id="filter-form" class="pure-form">
        <fieldset>
          <input id="filter-input" type="text" name="filter" placeholder="New entry...">
          <button type="submit" class="pure-button pure-button-primary">Submit</button>
        </fieldset>
      </form>

      <div class="log" id="log"></div>

      <hr/>

      <form id="entry-form" class="pure-form">
        <fieldset>
          <input type="text" name="entry" placeholder="New entry...">
          <button type="submit" class="pure-button pure-button-primary">Submit</button>
        </fieldset>
      </form>
    </div>
  </div>

  <div style="width: 100%; padding-bottom: 2em"></div>

  <script id="log-template" type="text/x-handlebars-template">
    <hr/>
    <h3 class="capitalized">9th / Thursday</h2>
    <ul class="fa-ul">
    {{#each this}}
      <li><span class="fa-li"><i class="fa fa-angle-right"></i></span>{{md content.Text.content}}</li>
    {{/each}}
    </ul>
  </script>

  <script id="error-template" type="text/x-handlebars-template">
    <div class="error">
      {{error}}
    </div>
  </script>

  <script>
  (function () {
    Handlebars.registerHelper('md', function(data) {
      return new Handlebars.SafeString(marked.inlineLexer(data, [], {}));
    });

    var loadTemplate = function (id) {
      return Handlebars.compile(document.getElementById(id).innerHTML);
    };

    var logTemplate = loadTemplate('log-template');
    var errorTemplate = loadTemplate('error-template');

    var reportError = function (error) {
      var content = errorTemplate({ error: error });
      document.getElementById('log').innerHTML = content;
    };

    var fetchLog = function (filter) {
      fetch(filter ? ('api/log?filter=' + filter) : 'api/log')
        .then(function (response) {
          var futureContent = null;

          if (response.status == 200 || response.status == 400) {
            futureContent = response.json();
          } else {
            futureContent = response.text();
          }

          return futureContent.then(function (content) {
            return { success: response.status == 200, content: content };
          });
        })
        .then(function (response) {
          if (response.success) {
            var content = logTemplate(response.content);
            document.getElementById('log').innerHTML = content;
          } else {
            reportError(response.content);
          }
        })
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        });
    }

    var saveEvent = function (content) {
      var request = {
        method: 'POST',
        body: JSON.stringify(content),
        headers: { 'content-type': 'application/json' }
      }

      fetch('api/save', request)
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        })
        .then(function (result) {
          console.log(result);
          return fetchLog();
        });
    }

    var processForm = function (cb) {
      return function (event) {
        if (event.preventDefault) event.preventDefault();
        cb(event.target);
        // prevent default form handler from running
        return false;
      }
    }

    var processFilterForm = processForm(function (target) {
      var filter = target.querySelectorAll('[name=filter]')[0];
      fetchLog(filter.value);
    })

    var processFilterInput = processForm(function (target) {
      console.log(target.value);
      fetchLog(target.value);
    })

    var processEntry = processForm(function (target) {
      var content = target.querySelectorAll('[name=entry]')[0];
      saveEvent(content.value);
    })

    var handleEvent = function (id, event, handler) {
      var element = document.getElementById(id);

      if (element.attachEvent) {
        element.attachEvent(event, handler);
      } else {
        element.addEventListener(event, handler);
      }
    }

    handleEvent('filter-input', 'input', processFilterInput);
    handleEvent('filter-form', 'submit', processFilterForm);
    handleEvent('entry-form', 'submit', processEntry);

    fetchLog();
  })();
  </script>
</body>
