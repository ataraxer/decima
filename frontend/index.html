
<head>
  <title>Decima</title>

  <!-- Meta information -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

  <!-- Styles -->
  <link rel="stylesheet" href="main.css" />
  <link rel="stylesheet" href="bower_components/pure/pure-min.css" />
  <link rel="stylesheet" href="bower_components/pure/grids-responsive-min.css">
  <link rel="stylesheet" href="bower_components/pure/tables-min.css">
  <link rel="stylesheet" href="bower_components/pure/forms-min.css">

  <script src="bower_components/handlebars/handlebars.min.js"></script>
  <script src="bower_components/fetch/fetch.js"></script>
  <script src="bower_components/marked/lib/marked.js"></script>

  <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
</head>
<body>
  <header class="wrapper">
    <div class="content">
      <form class="pure-form">
        <fieldset>
          <input id="filter-input" type="text" name="filter" placeholder="Filter by tag..." autocapitalize="off">
        </fieldset>
      </form>
    </div>
  </header>

  <div class="main">
    <div class="wrapper">
      <div class="content">
        <div id="tags" class="tags"></div>
        <hr/>
        <div class="log" id="log"></div>
      </div>
    </div>

    <footer class="wrapper">
      <div class="wide-content">
        <form id="entry-form" class="pure-form">
          <fieldset>
            <input type="text" name="entry" placeholder="New entry..." autocapitalize="off">
          </fieldset>
        </form>
      </div>
    </footer>
  </div>

  <script id="log-template" type="text/x-handlebars-template">
    <!--<h3 class="capitalized">9th / Thursday</h2>-->
    <ul class="fa-ul">
    {{#each this}}
      <li><span class="fa-li" data-badge="3"><i class="fa fa-angle-right"></i></span>{{md content.Text.content}}</li>
    {{/each}}
    </ul>
  </script>

  <script id="sorted-log-template" type="text/x-handlebars-template">
    {{#each this}}
      <h3 class="capitalized">{{date}}</h2>
      <ul class="fa-ul">
      {{#each events}}
        <li><span class="fa-li" data-badge="3"><i class="fa fa-angle-right"></i></span>{{md content.Text.content}}</li>
      {{/each}}
      </ul>
    {{/each}}
  </script>

  <script id="tags-template" type="text/x-handlebars-template">
    {{#each this}}
      <code>{{this}}</code>
    {{/each}}
  </script>

  <script id="error-template" type="text/x-handlebars-template">
    <div class="error">
      {{error}}
    </div>
  </script>

  <script>
  (function () {
    Handlebars.registerHelper('md', function(data) {
      return new Handlebars.SafeString(marked.inlineLexer(data, [], {}));
    });

    var loadTemplate = function (id) {
      return Handlebars.compile(document.getElementById(id).innerHTML);
    };

    var tagsTemplate = loadTemplate('tags-template');
    var logTemplate = loadTemplate('log-template');
    var sortedLogTemplate = loadTemplate('sorted-log-template');
    var errorTemplate = loadTemplate('error-template');

    var reportError = function (error) {
      var content = errorTemplate({ error: error });
      document.getElementById('log').innerHTML = content;
    };

    var handleTagClick = function (event) {
      if (event.target.tagName == 'CODE') {
        var filter = event.target.innerHTML.replace('#', '');
        document.getElementById('filter-input').value = filter;
        fetchLog(filter);
      }
    }

    document.addEventListener('click', handleTagClick);

    var fetchTags = function () {
      fetch('api/tags')
        .then(function (response) {
          var futureContent = null;

          if (response.status == 200 || response.status == 400) {
            futureContent = response.json();
          } else {
            futureContent = response.text();
          }

          return futureContent.then(function (content) {
            return { success: response.status == 200, content: content };
          });
        })
        .then(function (response) {
          if (response.success) {
            var content = tagsTemplate(response.content);
            document.getElementById('tags').innerHTML = content;
          } else {
            reportError(response.content);
          }
        })
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        });
    }

    var fetchLog = function (filter) {
      return fetch('api/log?filter=' + filter)
        .then(function (response) {
          var futureContent = null;

          if (response.status == 200 || response.status == 400) {
            futureContent = response.json();
          } else {
            futureContent = response.text();
          }

          return futureContent.then(function (content) {
            return { success: response.status == 200, content: content };
          });
        })
        .then(function (response) {
          if (response.success) {
            var content = logTemplate(response.content);
            document.getElementById('log').innerHTML = content;
          } else {
            reportError(response.content);
          }
        })
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        });
    }

    var fetchSortedLog = function () {
      return fetch('api/log-by-date')
        .then(function (response) {
          var futureContent = null;

          if (response.status == 200 || response.status == 400) {
            futureContent = response.json();
          } else {
            futureContent = response.text();
          }

          return futureContent.then(function (content) {
            return { success: response.status == 200, content: content };
          });
        })
        .then(function (response) {
          if (response.success) {
            var content = sortedLogTemplate(response.content);
            document.getElementById('log').innerHTML = content;
          } else {
            reportError(response.content);
          }
        })
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        });
    }

    var saveEvent = function (content) {
      var request = {
        method: 'POST',
        body: JSON.stringify(content),
        headers: { 'content-type': 'application/json' }
      }

      fetch('api/save', request)
        .catch(function (reason) {
          console.error('request failed', reason);
          reportError(reason);
        })
        .then(function (result) {
          return fetchTags();
        })
        .then(function (result) {
          return fetchSortedLog();
        })
        .then(function (result) {
          window.scrollTo(0, document.body.scrollHeight);
        });
    }

    var processForm = function (cb) {
      return function (event) {
        if (event.preventDefault) event.preventDefault();
        cb(event.target);
        // prevent default form handler from running
        return false;
      }
    }

    var processFilterInput = processForm(function (target) {
      if (target.value) {
        fetchLog(target.value);
      } else {
        fetchSortedLog();
      }
    })

    var processEntry = processForm(function (target) {
      var content = target.querySelectorAll('[name=entry]')[0];
      saveEvent(content.value);
      content.value = "";
    })

    var handleEvent = function (id, event, handler) {
      var element = document.getElementById(id);

      if (element.addEventListener) {
        element.addEventListener(event, handler);
      } else {
        element.attachEvent(event, handler);
      }
    }

    var debounce = function (func, wait, immediate) {
      var timeout;

      return function executedFunction() {
        var context = this;
        var args = arguments;

        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };

        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };

    handleEvent('filter-input', 'input', debounce(processFilterInput, 250));
    handleEvent('entry-form', 'submit', processEntry);

    fetchTags();
    fetchSortedLog();
  })();
  </script>
</body>
